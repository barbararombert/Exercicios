<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      height: 100vh;
      background: linear-gradient(to bottom, #eef4e8 0%, #e3ebda 100%);
      font-family: 'Poppins', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #111;
    }

    .container {
      width: 800px;
      height: 700px;
      background: #ffffff;
      border-radius: 25px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
      padding: 25px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }

    h2 {
      margin: 10px 0 0;
      font-weight: 500;
      color: #2f3e2f;
    }

    p {
      margin: 5px 0 20px;
      color: #5b6a5b;
      font-size: 14px;
    }

    video, canvas {
      width: 720px;
      height: 520px;
      border-radius: 20px;
      background: #000;
      object-fit: cover;
      transform: scaleX(-1);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .hidden { display: none; }

    .botoes {
      width: 100%;
      max-width: 720px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      margin-top: 20px;
    }

    button {
      background: #f5f7f2;
      border: none;
      color: #2f3e2f;
      padding: 8px 18px;
      border-radius: 10px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.25s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
    }

    button:hover {
      background: #9cc990;
      color: white;
      transform: translateY(-2px);
    }

    button.ativo {
      background: #7cbf73;
      color: white;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }

    #toggleCam {
      background: #b94a48;
      color: white;
      margin-top: 15px;
    }

    #toggleCam:hover {
      background: #d9534f;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Filtros Criativos</h2>
    <p>Usa as teclas <strong>1-7</strong> ou clica nos botões</p>

    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" class="hidden"></canvas>

    <div class="botoes">
      <button data-filtro="normal" class="ativo">Normal (1)</button>
      <button data-filtro="popart">Pop Art (2)</button>
      <button data-filtro="glitch">Glitch RGB (3)</button>
      <button data-filtro="poster">Posterizado (4)</button>
      <button data-filtro="thermo">Térmico (5)</button>
      <button data-filtro="wave">Ondas (6)</button>
      <button data-filtro="threshold">Verde (7)</button>
    </div>

    <button id="toggleCam">Parar Câmara</button>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const botoes = document.querySelectorAll('button[data-filtro]');
    const toggleCamBtn = document.getElementById('toggleCam');
    let filtroAtual = 'normal';
    let streamAtual = null;
    let camLigada = false;

    async function iniciarCam() {
      try {
        streamAtual = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = streamAtual;
        camLigada = true;
        toggleCamBtn.textContent = "Parar Câmara";
      } catch (err) {
        alert('Erro ao aceder à webcam.');
      }
    }

    function pararCam() {
      if (streamAtual) {
        streamAtual.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        camLigada = false;
        toggleCamBtn.textContent = "Ligar Câmara";
      }
    }

    toggleCamBtn.addEventListener('click', () => {
      if (camLigada) {
        pararCam();
      } else {
        iniciarCam();
      }
    });

    iniciarCam(); // inicia automaticamente ao abrir a página

    function desenhar() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        const w = video.videoWidth || 720;
        const h = video.videoHeight || 520;
        canvas.width = w; canvas.height = h;
        ctx.drawImage(video, 0, 0, w, h);
        let img = ctx.getImageData(0, 0, w, h);
        let data = img.data;

        switch (filtroAtual) {
          case 'popart':
            for (let i = 0; i < data.length; i += 4) {
              data[i] = Math.min(255, data[i] * 1.5);
              data[i+1] = data[i+1] * 0.5;
              data[i+2] = Math.min(255, data[i+2] + 60);
            }
            break;

          case 'glitch': {
            const src = new Uint8ClampedArray(data);
            const t = performance.now();
            const baseRx = Math.round(4 * Math.sin(t / 200));
            const baseBx = -baseRx;
            const clamp = (val, min, max) => Math.max(min, Math.min(max, val));
            for (let y = 0; y < h; y++) {
              const rx = clamp(baseRx + (y % 15 === 0 ? 6 : 0), -10, 10);
              const bx = clamp(baseBx - (y % 25 === 0 ? 4 : 0), -10, 10);
              for (let x = 0; x < w; x++) {
                const idx = (y * w + x) * 4;
                const idxR = (y * w + clamp(x + rx, 0, w - 1)) * 4;
                const idxB = (y * w + clamp(x + bx, 0, w - 1)) * 4;
                data[idx] = src[idxR];
                data[idx + 2] = src[idxB + 2];
              }
            }
            break;
          }

          case 'poster':
            for (let i = 0; i < data.length; i += 4) {
              data[i] = (data[i] & 0xC0);
              data[i+1] = (data[i+1] & 0xC0);
              data[i+2] = (data[i+2] & 0xC0);
            }
            break;

          case 'thermo':
            for (let i = 0; i < data.length; i += 4) {
              const br = (data[i] + data[i+1] + data[i+2]) / 3;
              data[i] = br < 85 ? 0 : br < 170 ? 255 : 255;
              data[i+1] = br < 85 ? 0 : br < 170 ? br : 0;
              data[i+2] = br < 85 ? 255 : br < 170 ? 0 : 0;
            }
            break;

          case 'wave': {
            const src = ctx.getImageData(0, 0, w, h);
            const srcData = src.data;
            const out = ctx.createImageData(w, h);
            const outData = out.data;
            const amp = 10, freq = 0.02, t = performance.now() / 300;
            for (let y = 0; y < h; y++) {
              for (let x = 0; x < w; x++) {
                const offsetX = Math.round(amp * Math.sin(2 * Math.PI * (y * freq) + t));
                const sx = Math.max(0, Math.min(w - 1, x + offsetX));
                const si = (y * w + sx) * 4;
                const di = (y * w + x) * 4;
                outData[di] = srcData[si];
                outData[di+1] = srcData[si+1];
                outData[di+2] = srcData[si+2];
                outData[di+3] = 255;
              }
            }
            img = out;
            break;
          }

          case 'threshold':
            for (let i = 0; i < data.length; i += 4) {
              const br = (data[i] + data[i+1] + data[i+2]) / 3;
              if (br > 127) {
                data[i]=255; data[i+1]=255; data[i+2]=255;
              } else {
                data[i]=0; data[i+1]=255; data[i+2]=0;
              }
            }
            break;
        }

        ctx.putImageData(img, 0, 0);
      }

      if (filtroAtual !== 'normal') requestAnimationFrame(desenhar);
    }

    function aplicarFiltro(filtro) {
      botoes.forEach(b => b.classList.remove('ativo'));
      document.querySelector(`[data-filtro="${filtro}"]`)?.classList.add('ativo');
      filtroAtual = filtro;

      if (filtro === 'normal') {
        video.classList.remove('hidden');
        canvas.classList.add('hidden');
      } else {
        video.classList.add('hidden');
        canvas.classList.remove('hidden');
        requestAnimationFrame(desenhar);
      }
    }

    botoes.forEach(btn => btn.addEventListener('click', () => aplicarFiltro(btn.dataset.filtro)));

    document.addEventListener('keydown', (e) => {
      const teclas = { '1':'normal','2':'popart','3':'glitch','4':'poster','5':'thermo','6':'wave','7':'threshold' };
      if (teclas[e.key]) aplicarFiltro(teclas[e.key]);
    });
  </script>
</body>
</html>
